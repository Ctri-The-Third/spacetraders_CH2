<!doctype html>
<html lang="en">

{% include '_header.html' %}
{% include 'top_menu.html' %}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12 col-lg-2">
            <h1>All trades <a onclick="socket.emit('fetch-trades');return false;">ðŸ”ƒ</a></h1>
            select ship:
            <select id="list_of_ship_symbols" onchange="fetch_ship();">
                {% for ship in ships %}
                <option value="{{ship.symbol}}">{{ship.symbol}}</option>
                {% endfor %}
            </select>

        </div>
        <div class=" col-lg-2 col-md-2 col-sm-6  ">
            <div id="selected_ship"></div>
            <div id="selected_ship_controls">
                <input type="button" value="execute best for ship" id="ship_autopilot_control"
                    onclick="execute_best(); return false;" /><br />
                Autopilot? <input type="checkbox" id="auto_execute" value="auto_execute"
                    onclick="toggle_autopilot(); return false;" />
            </div>

        </div>
        <div class="col-lg-6 col-md-6 col-sm-12 logs_output" id="logs_output">

        </div>
    </div>
</div>
<div id="trades_output" style="border:1px solid red;">
    {% for system in trades %}
    <h2>{{system}}</h2>
    <table id="trades_{{system}}">

    </table>
    {% endfor %}

</div>
<script>
    function execute_trade(trade_symbol, start_location, end_location, quantity) {
        socket.emit('execute-trade', {
            'ship_name': document.getElementById('list_of_ship_symbols').value,
            'trade_symbol': trade_symbol,
            'start_location': start_location,
            'end_location': end_location,
            'quantity': quantity
        })
    }

    function fetch_ship() {
        new_ship = document.getElementById('list_of_ship_symbols').value;
        socket.emit('fetch-ship-box', new_ship);
        socket.emit("fetch-ship-autopilotstate", new_ship);
    }


    socket.emit('fetch-trades');
    socket.emit("fetch-ship-autopilotstate", document.getElementById('list_of_ship_symbols').value);
    fetch_ship();

    function execute_best() {
        socket.emit('execute-best-trade', document.getElementById('list_of_ship_symbols').value);
    }

    function toggle_autopilot() {
        socket.emit('toggle-autopilot', document.getElementById('list_of_ship_symbols').value);
    }

    socket.on("autopilot-update", function (data) {
        div = document.getElementById('selected_ship_controls');
        if (!div) { console.log("received autopilot-update but no selected_ship_controls found"); return }
        if (data.is_locked) {
            document.getElementById('auto_execute').checked = true;
        } else {
            document.getElementById('auto_execute').checked = false;
        }
    });

    socket.on("trades-update", function (data) {
        console.log("trades-update: received [" + data.length + "] trades");
        div = document.getElementById('trades_output');
        if (!div) { console.log("received trades-update but no trades_output found"); return }
        for (system in data) {
            prefix = "trades_" + system;
            table = document.getElementById(prefix);


            table.innerHTML = '';

            var newRow = table.insertRow();
            newCell = document.createElement("th");
            newCell.textContent = "Symbol";
            newRow.appendChild(newCell);

            newCell = document.createElement("th");
            newCell.textContent = "Start/end";
            newRow.appendChild(newCell);

            newCell = document.createElement("th");
            newCell.textContent = "Distance";
            newRow.appendChild(newCell);

            newCell = document.createElement("th");
            newCell.textContent = "Quantity";
            newRow.appendChild(newCell);


            newCell = document.createElement("th");
            newCell.textContent = "q/hour";
            newRow.appendChild(newCell);


            newCell = document.createElement("th");
            newCell.textContent = "profit_per_distance";
            newRow.appendChild(newCell);

            newCell = document.createElement("th");
            newCell.textContent = "Execute";
            newRow.appendChild(newCell);

            for (var key in data[system]) {
                op = data[system][key];
                var newRow = table.insertRow();
                var newCell = newRow.insertCell(0);
                text_content = "<a href = '/trade/" + system + "/" + op.trade_symbol + "'>"
                text_content += "<img src='/static/icons/GOOD_" + op.trade_symbol + ".png'/>" + op.trade_symbol;
                text_content += "</a>";
                newCell.innerHTML = text_content;

                var newCell = newRow.insertCell(1);
                text_content = op.start_location + " -> " + op.end_location;
                newCell.innerHTML = text_content;

                var newCell = newRow.insertCell(2);
                text_content = op.distance;
                newCell.innerHTML = text_content;

                var newCell = newRow.insertCell(3);
                text_content = "<img src='/static/icons/" + op.supply + ".png' />" + op.total_quantity + " (" + op.export_tv + ")";
                newCell.innerHTML = text_content;

                var newCell = newRow.insertCell(4);
                text_content = "<img src='/static/icons/" + op.activity + ".png' />" + op.goods_produced_per_hour;
                newCell.innerHTML = text_content;

                var newCell = newRow.insertCell(5);
                profit_per_distance = op.cph_of_goods_produced;
                newCell.innerHTML = profit_per_distance;


                var newCell = newRow.insertCell(6);
                emit_instruction = 'execute_trade(\"' + op.trade_symbol + '\", \"' + op.start_location + '\", \"' + op.end_location + '\", \"' + op.total_quantity + '\")';
                inner_html = "<input type = 'button' value = 'execute' onclick='" + emit_instruction + "'/> ";
                newCell.innerHTML = inner_html;

            }

        }
    });
</script>